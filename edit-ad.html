<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Ad | ShopNest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase & ImageKit -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <nav class="bg-white shadow px-4 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold text-indigo-600">ShopNest</h1>
    <div class="space-x-4 text-gray-600">
      <a href="dashboard.html" class="hover:text-indigo-500">Dashboard</a>
      <a href="index.html" class="hover:text-indigo-500">Home</a>
    </div>
  </nav>

  <main class="max-w-xl mx-auto mt-8 p-4 bg-white shadow rounded">
    <h2 class="text-xl font-semibold mb-4 text-center">Edit Your Ad</h2>
    <form id="editAdForm" class="space-y-4">
      <input type="text" id="title" class="w-full border p-2 rounded" placeholder="Title" required />
      <input type="number" id="price" class="w-full border p-2 rounded" placeholder="Price (₦)" required />
      <input type="text" id="location" class="w-full border p-2 rounded" placeholder="Location" required />
      <input type="number" id="deliveryTime" class="w-full border p-2 rounded" placeholder="Delivery Time (days)" required />

      <select id="category" class="w-full border p-2 rounded" required>
        <option value="">Select Category</option>
        <option>Fashion</option>
        <option>Electronics</option>
        <option>Automobile</option>
        <option>Services</option>
        <option>Phones & Tablets</option>
        <option>Computing</option>
        <option>Real Estate</option>
        <option>Home & Furniture</option>
        <option>Health & Beauty</option>
        <option>Baby, Kids & Toys</option>
        <option>Gaming</option>
        <option>Sports & Outdoors</option>
        <option>Groceries</option>
        <option>Books & Media</option>
        <option>Pet Supplies</option>
        <option>Agriculture</option>
        <option>Industrial Equipment</option>
        <option>Musical Instruments</option>
        <option>Watches & Jewelry</option>
        <option>Security & Surveillance</option>
        <option>Food & Drink</option>
        <option>Office Equipment</option>
        <option>Power & Energy</option>
        <option>Travel & Luggage</option>
        <option>Arts & Crafts</option>
        <option>Tickets & Events</option>
        <option>Education</option>
        <option>Machinery</option>
        <option>Other</option>
      </select>

      <div id="extra-fields" class="space-y-2"></div>

      <p id="statusMsg" class="text-center text-sm mt-2"></p>

      <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded w-full hover:bg-indigo-700">
        Save Changes
      </button>
    </form>
  </main>

  <script>
    const supabase = supabase.createClient(
      "https://oryydgfrezvhfqdkhjsx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yeXlkZ2ZyZXp2aGZxZGtoanN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MzA5NjMsImV4cCI6MjA2ODAwNjk2M30.KMsr_RYFZaldt_hMfkHh2Qn-Mq5fIjk5Beb8cQQmt8Y"
    );

    const urlParams = new URLSearchParams(window.location.search);
    const adId = urlParams.get("id");

    const titleInput = document.getElementById("title");
    const priceInput = document.getElementById("price");
    const locationInput = document.getElementById("location");
    const deliveryInput = document.getElementById("deliveryTime");
    const categoryInput = document.getElementById("category");
    const extraFields = document.getElementById("extra-fields");
    const statusMsg = document.getElementById("statusMsg");

    function showSubOptions(category, subOptions = {}) {
      extraFields.innerHTML = "";

      if (category === "Fashion") {
        extraFields.innerHTML = `
          <input name="Brand" placeholder="Brand" class="w-full border p-2 rounded" value="${subOptions.Brand || ""}" />
          <input name="Size" placeholder="Size (e.g. M, L, XL)" class="w-full border p-2 rounded" value="${subOptions.Size || ""}" />
          <input name="Color" placeholder="Color" class="w-full border p-2 rounded" value="${subOptions.Color || ""}" />
          <select name="Gender" class="w-full border p-2 rounded">
            <option disabled ${!subOptions.Gender ? "selected" : ""}>Gender</option>
            <option ${subOptions.Gender === "Male" ? "selected" : ""}>Male</option>
            <option ${subOptions.Gender === "Female" ? "selected" : ""}>Female</option>
            <option ${subOptions.Gender === "Unisex" ? "selected" : ""}>Unisex</option>
          </select>
        `;
      } else if (category === "Electronics") {
        extraFields.innerHTML = `
          <input name="Brand" placeholder="Brand" class="w-full border p-2 rounded" value="${subOptions.Brand || ""}" />
          <input name="Model" placeholder="Model" class="w-full border p-2 rounded" value="${subOptions.Model || ""}" />
          <input name="Warranty" placeholder="Warranty (e.g. 1 Year)" class="w-full border p-2 rounded" value="${subOptions.Warranty || ""}" />
        `;
      } else if (category === "Real Estate") {
        extraFields.innerHTML = `
          <input name="Property Type" placeholder="Property Type" class="w-full border p-2 rounded" value="${subOptions['Property Type'] || ""}" />
          <input name="Rooms" placeholder="No. of Rooms" class="w-full border p-2 rounded" value="${subOptions.Rooms || ""}" />
          <select name="Furnishing" class="w-full border p-2 rounded">
            <option disabled ${!subOptions.Furnishing ? "selected" : ""}>Furnishing</option>
            <option ${subOptions.Furnishing === "Furnished" ? "selected" : ""}>Furnished</option>
            <option ${subOptions.Furnishing === "Semi-Furnished" ? "selected" : ""}>Semi-Furnished</option>
            <option ${subOptions.Furnishing === "Unfurnished" ? "selected" : ""}>Unfurnished</option>
          </select>
        `;
      }
    }

    categoryInput.addEventListener("change", () => {
      showSubOptions(categoryInput.value);
    });

    async function loadAdData() {
      if (!adId) {
        statusMsg.textContent = "Invalid ad ID.";
        statusMsg.className = "text-red-600 text-center";
        return;
      }

      const { data, error } = await supabase.from("ads").select("*").eq("id", adId).single();
      if (error || !data) {
        statusMsg.textContent = "Ad not found or error loading.";
        statusMsg.className = "text-red-600 text-center";
        return;
      }

      titleInput.value = data.title;
      priceInput.value = data.price;
      locationInput.value = data.location;
      deliveryInput.value = data.deliveryTime;
      categoryInput.value = data.category;
      showSubOptions(data.category, data.subOptions || {});
    }

    document.getElementById("editAdForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "";

      const subOptions = {};
      [...extraFields.querySelectorAll("input, select")].forEach(input => {
        if (input.name && input.value) {
          subOptions[input.name] = input.value;
        }
      });

      const updatedAd = {
        title: titleInput.value.trim(),
        price: parseFloat(priceInput.value),
        location: locationInput.value.trim(),
        deliveryTime: parseInt(deliveryInput.value),
        category: categoryInput.value,
        subOptions
      };

      const { error } = await supabase.from("ads").update(updatedAd).eq("id", adId);
      if (error) {
        statusMsg.textContent = "❌ Failed to update ad.";
        statusMsg.className = "text-red-600 text-center";
      } else {
        statusMsg.textContent = "✅ Ad updated successfully!";
        statusMsg.className = "text-green-600 text-center";
        setTimeout(() => window.location.href = "dashboard.html", 1000);
      }
    });

    loadAdData();
  </script>
</body>
</html>
